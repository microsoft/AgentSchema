// Copyright (c) Microsoft. All rights reserved.
using System.Buffers;
using System.Text.Json;
using System.Text.Json.Serialization;

#pragma warning disable IDE0130
namespace {{ node.typeName.namespace }};
#pragma warning restore IDE0130

public class {{ node.typeName.name }}JsonConverter: JsonConverter<{{ node.typeName.name }}>
{
    public override {{ node.typeName.name }} Read(ref Utf8JsonReader reader, Type typeToConvert, JsonSerializerOptions options)
    {
        if (reader.TokenType == JsonTokenType.Null)
        {
            throw new JsonException("Cannot convert null value to {{ node.typeName.name }}.");
        }
        {%- for alt in alternates %}
            {%- if alt.scalar == "bool" %}
        else if (reader.TokenType == JsonTokenType.True || reader.TokenType == JsonTokenType.False)
        {
            var {{ alt.scalar }}Value = reader.GetBoolean();
            return new {{ node.typeName.name }}()
            {
                {%- for item in alt.expansion %}
                {{ item.property }} = {{ item.value | safe }},
                {%- endfor %}
            };
        }
            {%- elif alt.scalar == "float" or alt.scalar == "int" %}
        else if (reader.TokenType == JsonTokenType.Number)
        {
            var {{ alt.scalar }}Value = reader.Get{% if alt.scalar == "float" %}Single{% else %}Int32{% endif %}();
            return new {{ node.typeName.name }}()
            {
                {%- for item in alt.expansion %}
                {{ item.property }} = {{ item.value | safe }},
                {%- endfor %}
            };
        }
            {%- else %}
        else if (reader.TokenType == JsonTokenType.{{ alt.scalar | capitalize }})
        {
            var {{ alt.scalar }}Value = reader.{{ converterMapper(alt.scalar) }}() ?? throw new JsonException("Empty {{ alt.scalar }} shorthand values for {{ node.typeName.name }} are not supported");
            {%- if polymorphicTypes %}
            // load polymorphic {{ node.typeName.name }} instance
            {{ node.typeName.name }} instance;
            instance = {{ alt.scalar }}Value.ToLowerInvariant() switch 
            {
                {%- for type in polymorphicTypes.types %}
                "{{ type.value }}" => new {{ type.instance.typeName.name }}(),
                {%- endfor %}
                {%- if polymorphicTypes.default %}
                _ => new {{ polymorphicTypes.default.instance.typeName.name }}(),
                {%- else %}
                _ => throw new JsonException($"Unknown {{ node.typeName.name }} discriminator value: { {{ alt.scalar }}Value }"),
                {%- endif %}
            };
            {%- for item in alt.expansion %}
            instance.{{ item.property }} = {{ item.value | safe }};
            {%- endfor %}
            return instance;
            {%- else %}
            return new {{ node.typeName.name }}()
            {
                {%- for item in alt.expansion %}
                {{ item.property }} = {{ item.value | safe }},
                {%- endfor %}
            };
            {%- endif %}
            
        }
            {%- endif %}
        {%- endfor %}
        {%- if numericAlternates.length > 0 %}
        else if (reader.TokenType == JsonTokenType.Number)
        {
            byte[] span = reader.HasValueSequence ?
                        reader.ValueSequence.ToArray() :
                        reader.ValueSpan.ToArray();

            var numberString = System.Text.Encoding.UTF8.GetString(span);
            {%- for alt in numericAlternates %}
            {%- if loop.first %}
            if (
            {%- if alt.scalar == "float" -%}
            numberString.Contains('.') || numberString.Contains('e') || numberString.Contains('E'))
            {%- else -%}
            numberString.All(c => char.IsDigit(c))
            {%- endif -%}
            {%- else %}
            else 
            {%- endif %}
            {
                // try parse as {{ alt.scalar }}
                {%- if alt.scalar == "float" %}
                if (float.TryParse(numberString, out float floatValue))
                {%- else %}
                if (int.TryParse(numberString, out int intValue))
                {%- endif %}
                {
                    return new {{ node.typeName.name }}()
                    {
                        {%- for item in alt.expansion %}
                        {{ item.property }} = {{ item.value | safe }},
                        {%- endfor %}
                    };
                }
            }
            {%- endfor %}
        }
        {%- endif %}
        else if (reader.TokenType != JsonTokenType.StartObject)
        {
            throw new JsonException($"Unexpected JSON token when parsing {{ node.typeName.name }}: {reader.TokenType}");
        }

        // Parse JSON to Dictionary and delegate to Load method
        using var jsonDocument = JsonDocument.ParseValue(ref reader);
        var data = JsonElementToDictionary(jsonDocument.RootElement);
        return {{ node.typeName.name }}.Load(data);
    }

    private static Dictionary<string, object?> JsonElementToDictionary(JsonElement element)
    {
        var dict = new Dictionary<string, object?>();
        foreach (var property in element.EnumerateObject())
        {
            dict[property.Name] = JsonElementToObject(property.Value);
        }
        return dict;
    }

    private static object? JsonElementToObject(JsonElement element)
    {
        return element.ValueKind switch
        {
            JsonValueKind.Object => JsonElementToDictionary(element),
            JsonValueKind.Array => element.EnumerateArray().Select(JsonElementToObject).ToList(),
            JsonValueKind.String => element.GetString(),
            JsonValueKind.Number => element.TryGetInt32(out var i) ? i : element.GetDouble(),
            JsonValueKind.True => true,
            JsonValueKind.False => false,
            JsonValueKind.Null => null,
            _ => null
        };
    }

    public override void Write(Utf8JsonWriter writer, {{ node.typeName.name }} value, JsonSerializerOptions options)
    {
        // Delegate to Save method and write the dictionary
        var dict = value.Save();
        JsonSerializer.Serialize(writer, dict, options);
    }
}