{#
  Rust Integration Test Template
  ===============================
  Renders Rust integration test file for a type.

  Expected context (BaseTestContext):
    - node: TypeNode
    - package: string
    - isAbstract: boolean
    - examples: Array<{ json: string[], yaml: string[], validations: Array<{ key, value, delimiter, isOptional }> }>
    - alternates: Array<{ title, scalarType, value, validations: Array<{ key, value, delimiter, isOptional }> }>
#}
// Code generated by AgentSchema emitter; DO NOT EDIT.

use {{ package }}::*;

{% for sample in examples %}
#[test]
fn test_{{ node.typeName.name | snakeCase }}_load_json{% if not loop.first %}_{{ loop.index - 1 }}{% endif %}() {
    let json_data = r####"
{%- for line in sample.json %}
{{ line }}
{%- endfor %}
"####;
    let instance = {{ node.typeName.name }}::from_json(json_data).expect("Failed to load {{ node.typeName.name }} from JSON");
{%- if isAbstract %}
    // Polymorphic base type â€“ use from_json_polymorphic for dispatch
    let _ = instance;
{%- elif sample.validations.length > 0 %}
{%- for validation in sample.validations %}
{%- if validation.isOptional %}
{%- if validation.delimiter %}
    assert_eq!(instance.{{ validation.key }}.as_deref(), Some("{{ validation.value }}"));
{%- else %}
    assert_eq!(instance.{{ validation.key }}, Some({{ validation.value }}));
{%- endif %}
{%- else %}
{%- if validation.delimiter %}
    assert_eq!(instance.{{ validation.key }}, "{{ validation.value }}");
{%- else %}
    assert_eq!(instance.{{ validation.key }}, {{ validation.value }});
{%- endif %}
{%- endif %}
{%- endfor %}
{%- else %}
    let _ = instance; // No scalar properties to validate
{%- endif %}
}

#[test]
fn test_{{ node.typeName.name | snakeCase }}_load_yaml{% if not loop.first %}_{{ loop.index - 1 }}{% endif %}() {
    let yaml_data = r####"
{%- for line in sample.yaml %}
{{ line }}
{%- endfor %}
"####;
    let instance = {{ node.typeName.name }}::from_yaml(yaml_data).expect("Failed to load {{ node.typeName.name }} from YAML");
{%- if isAbstract %}
    let _ = instance;
{%- elif sample.validations.length > 0 %}
{%- for validation in sample.validations %}
{%- if validation.isOptional %}
{%- if validation.delimiter %}
    assert_eq!(instance.{{ validation.key }}.as_deref(), Some("{{ validation.value }}"));
{%- else %}
    assert_eq!(instance.{{ validation.key }}, Some({{ validation.value }}));
{%- endif %}
{%- else %}
{%- if validation.delimiter %}
    assert_eq!(instance.{{ validation.key }}, "{{ validation.value }}");
{%- else %}
    assert_eq!(instance.{{ validation.key }}, {{ validation.value }});
{%- endif %}
{%- endif %}
{%- endfor %}
{%- else %}
    let _ = instance;
{%- endif %}
}

#[test]
fn test_{{ node.typeName.name | snakeCase }}_roundtrip{% if not loop.first %}_{{ loop.index - 1 }}{% endif %}() {
    let json_data = r####"
{%- for line in sample.json %}
{{ line }}
{%- endfor %}
"####;
    let instance = {{ node.typeName.name }}::from_json(json_data).expect("Failed to load {{ node.typeName.name }}");
{%- if isAbstract %}
    let _ = instance;
{%- else %}
    let json_out = instance.to_json().expect("Failed to serialize {{ node.typeName.name }} to JSON");
    let reloaded = {{ node.typeName.name }}::from_json(&json_out).expect("Failed to reload {{ node.typeName.name }} from JSON");
{%- if sample.validations.length > 0 %}
{%- for validation in sample.validations %}
{%- if validation.isOptional %}
{%- if validation.delimiter %}
    assert_eq!(reloaded.{{ validation.key }}.as_deref(), Some("{{ validation.value }}"));
{%- else %}
    assert_eq!(reloaded.{{ validation.key }}, Some({{ validation.value }}));
{%- endif %}
{%- else %}
{%- if validation.delimiter %}
    assert_eq!(reloaded.{{ validation.key }}, "{{ validation.value }}");
{%- else %}
    assert_eq!(reloaded.{{ validation.key }}, {{ validation.value }});
{%- endif %}
{%- endif %}
{%- endfor %}
{%- else %}
    let _ = reloaded;
{%- endif %}
{%- endif %}
}

#[test]
fn test_{{ node.typeName.name | snakeCase }}_to_json{% if not loop.first %}_{{ loop.index - 1 }}{% endif %}() {
    let json_data = r####"
{%- for line in sample.json %}
{{ line }}
{%- endfor %}
"####;
    let instance = {{ node.typeName.name }}::from_json(json_data).expect("Failed to load {{ node.typeName.name }}");
{%- if isAbstract %}
    let _ = instance;
{%- else %}
    let json_out = instance.to_json().expect("Failed to convert {{ node.typeName.name }} to JSON");
    // Verify the output is valid JSON
    let _: serde_json::Value = serde_json::from_str(&json_out).expect("Generated JSON is not valid");
{%- endif %}
}

#[test]
fn test_{{ node.typeName.name | snakeCase }}_to_yaml{% if not loop.first %}_{{ loop.index - 1 }}{% endif %}() {
    let json_data = r####"
{%- for line in sample.json %}
{{ line }}
{%- endfor %}
"####;
    let instance = {{ node.typeName.name }}::from_json(json_data).expect("Failed to load {{ node.typeName.name }}");
{%- if isAbstract %}
    let _ = instance;
{%- else %}
    let yaml_out = instance.to_yaml().expect("Failed to convert {{ node.typeName.name }} to YAML");
    // Verify the output is valid YAML by re-loading
    let _: serde_json::Value = serde_yaml::from_str(&yaml_out).expect("Generated YAML is not valid");
{%- endif %}
}

{% endfor %}

{% if alternates.length > 0 %}
{% for alt in alternates %}
#[test]
fn test_{{ node.typeName.name | snakeCase }}_from_{{ alt.title | lower | replace(" ", "_") }}{% if not loop.first %}_{{ loop.index }}{% endif %}() {
    // Test shorthand: {{ alt.scalarType }} -> {{ node.typeName.name }}
    let json_input = r####"{{ alt.value }}"####;
    let instance = {{ node.typeName.name }}::from_json(json_input).expect("Failed to load {{ node.typeName.name }} from {{ alt.scalarType }}");
{%- if isAbstract %}
    let _ = instance;
{%- elif alt.validations.length > 0 %}
{%- for item in alt.validations %}
{%- if item.isOptional %}
{%- if item.delimiter %}
    assert_eq!(instance.{{ item.key }}.as_deref(), Some("{{ item.value }}"));
{%- else %}
    assert_eq!(instance.{{ item.key }}, Some({{ item.value }}));
{%- endif %}
{%- else %}
{%- if item.delimiter %}
    assert_eq!(instance.{{ item.key }}, "{{ item.value }}");
{%- else %}
    assert_eq!(instance.{{ item.key }}, {{ item.value }});
{%- endif %}
{%- endif %}
{%- endfor %}
{%- else %}
    let _ = instance;
{%- endif %}
}

{% endfor %}
{% endif %}
