{#
  Rust Test Template
  ==================
  Renders integration test file for a TypeSpec model type.

  Expected context (BaseTestContext):
    - node: TypeNode
    - isAbstract: boolean
    - examples: Array<{ json: string[], yaml: string[], validations: Array<{ key, value, delimiter, isOptional }> }>
    - alternates: Array<{ title, scalarType, value, validations: Array<{ key, value, delimiter, isOptional }> }>
#}
// Code generated by AgentSchema emitter; DO NOT EDIT.

use agentschema::{{ node.typeName.name }};

{% for sample in examples %}
#[test]
fn test_{{ node.typeName.name | snakeCase }}_load_json{% if not loop.first %}_{{ loop.index - 1 }}{% endif %}() {
    let json = r####"
{%- for line in sample.json %}
{{ line }}
{%- endfor %}
"####;
    let result = {{ node.typeName.name }}::from_json(json);
    assert!(result.is_ok(), "Failed to load from JSON: {:?}", result.err());
    {%- if not isAbstract %}
    let instance = result.unwrap();
    {%- for validation in sample.validations %}
    {%- if validation.isOptional %}
    assert!(instance.{{ validation.key }}.is_some(), "Expected {{ validation.key }} to be Some");
    assert_eq!(instance.{{ validation.key }}.as_ref().unwrap(), &{{ validation.delimiter }}{{ validation.value }}{{ validation.delimiter }});
    {%- else %}
    assert_eq!(instance.{{ validation.key }}, {{ validation.delimiter }}{{ validation.value }}{{ validation.delimiter }});
    {%- endif %}
    {%- endfor %}
    {%- endif %}
}

#[test]
fn test_{{ node.typeName.name | snakeCase }}_load_yaml{% if not loop.first %}_{{ loop.index - 1 }}{% endif %}() {
    let yaml = r####"
{%- for line in sample.yaml %}
{{ line }}
{%- endfor %}
"####;
    let result = {{ node.typeName.name }}::from_yaml(yaml);
    assert!(result.is_ok(), "Failed to load from YAML: {:?}", result.err());
    {%- if not isAbstract %}
    let instance = result.unwrap();
    {%- for validation in sample.validations %}
    {%- if validation.isOptional %}
    assert!(instance.{{ validation.key }}.is_some(), "Expected {{ validation.key }} to be Some");
    {%- else %}
    assert_eq!(instance.{{ validation.key }}, {{ validation.delimiter }}{{ validation.value }}{{ validation.delimiter }});
    {%- endif %}
    {%- endfor %}
    {%- endif %}
}

#[test]
fn test_{{ node.typeName.name | snakeCase }}_roundtrip{% if not loop.first %}_{{ loop.index - 1 }}{% endif %}() {
    let json = r####"
{%- for line in sample.json %}
{{ line }}
{%- endfor %}
"####;
    let result = {{ node.typeName.name }}::from_json(json);
    assert!(result.is_ok(), "Failed to load: {:?}", result.err());
    {%- if not isAbstract %}
    let instance = result.unwrap();
    let json_output = instance.to_json();
    assert!(json_output.is_ok(), "Failed to serialize to JSON: {:?}", json_output.err());
    {%- endif %}
}

{% endfor %}
{% for alt in alternates %}
#[test]
fn test_{{ node.typeName.name | snakeCase }}_from_{{ alt.title | lower }}{% if not loop.first %}_{{ loop.index }}{% endif %}() {
    let value = serde_json::json!({{ alt.value }});
    let instance = {{ node.typeName.name }}::load_from_value(&value);
    {%- if not isAbstract %}
    {%- for item in alt.validations %}
    {%- if item.isOptional %}
    assert!(instance.{{ item.key }}.is_some());
    {%- else %}
    assert_eq!(instance.{{ item.key }}, {{ item.delimiter }}{{ item.value }}{{ item.delimiter }});
    {%- endif %}
    {%- endfor %}
    {%- endif %}
}

{% endfor %}
