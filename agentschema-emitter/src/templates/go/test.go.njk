{#
  Go Test Template
  ================
  Renders Go test file for a type.
  
  Expected context (GoTestContext):
    - node: TypeNode
    - packageName: string
    - examples: Array<{ json: string[], yaml: string[], validation: Array<{ key, value, delimeter }> }>
    - alternates: Array<{ title, scalar, value, validation: Array<{ key, value, delimeter }> }>
#}
{% import "_macros.njk" as go %}
// Code generated by AgentSchema emitter; DO NOT EDIT.

package {{ packageName }}_test

import (
	"encoding/json"
	"testing"
	
	"gopkg.in/yaml.v3"
	
	"github.com/microsoft/agentschema-go/{{ packageName }}"
)

{% for sample in examples %}
// Test{{ node.typeName.name }}LoadJSON{% if not loop.first %}{{ loop.index - 1 }}{% endif %} tests loading {{ node.typeName.name }} from JSON
func Test{{ node.typeName.name }}LoadJSON{% if not loop.first %}{{ loop.index - 1 }}{% endif %}(t *testing.T) {
	jsonData := `
{%- for line in sample.json %}
{{ line }}
{%- endfor %}
`
	var data map[string]interface{}
	if err := json.Unmarshal([]byte(jsonData), &data); err != nil {
		t.Fatalf("Failed to parse JSON: %v", err)
	}
	
	ctx := {{ packageName }}.NewLoadContext()
	instance, err := {{ packageName }}.Load{{ node.typeName.name }}(data, ctx)
	if err != nil {
		t.Fatalf("Failed to load {{ node.typeName.name }}: %v", err)
	}
	
	{%- for validation in sample.validation %}
	if instance.{{ validation.key }} != {{ validation.delimeter }}{{ validation.value }}{{ validation.delimeter }} {
		t.Errorf("Expected {{ validation.key }} to be {{ validation.delimeter }}{{ validation.value }}{{ validation.delimeter }}, got %v", instance.{{ validation.key }})
	}
	{%- endfor %}
}

// Test{{ node.typeName.name }}LoadYAML{% if not loop.first %}{{ loop.index - 1 }}{% endif %} tests loading {{ node.typeName.name }} from YAML
func Test{{ node.typeName.name }}LoadYAML{% if not loop.first %}{{ loop.index - 1 }}{% endif %}(t *testing.T) {
	yamlData := `
{%- for line in sample.yaml %}
{{ line }}
{%- endfor %}
`
	var data map[string]interface{}
	if err := yaml.Unmarshal([]byte(yamlData), &data); err != nil {
		t.Fatalf("Failed to parse YAML: %v", err)
	}
	
	ctx := {{ packageName }}.NewLoadContext()
	instance, err := {{ packageName }}.Load{{ node.typeName.name }}(data, ctx)
	if err != nil {
		t.Fatalf("Failed to load {{ node.typeName.name }}: %v", err)
	}
	
	{%- for validation in sample.validation %}
	if instance.{{ validation.key }} != {{ validation.delimeter }}{{ validation.value }}{{ validation.delimeter }} {
		t.Errorf("Expected {{ validation.key }} to be {{ validation.delimeter }}{{ validation.value }}{{ validation.delimeter }}, got %v", instance.{{ validation.key }})
	}
	{%- endfor %}
}

// Test{{ node.typeName.name }}Roundtrip{% if not loop.first %}{{ loop.index - 1 }}{% endif %} tests load -> save -> load produces equivalent data
func Test{{ node.typeName.name }}Roundtrip{% if not loop.first %}{{ loop.index - 1 }}{% endif %}(t *testing.T) {
	jsonData := `
{%- for line in sample.json %}
{{ line }}
{%- endfor %}
`
	var data map[string]interface{}
	if err := json.Unmarshal([]byte(jsonData), &data); err != nil {
		t.Fatalf("Failed to parse JSON: %v", err)
	}
	
	loadCtx := {{ packageName }}.NewLoadContext()
	instance, err := {{ packageName }}.Load{{ node.typeName.name }}(data, loadCtx)
	if err != nil {
		t.Fatalf("Failed to load {{ node.typeName.name }}: %v", err)
	}
	
	saveCtx := {{ packageName }}.NewSaveContext()
	savedData := instance.Save(saveCtx)
	
	reloaded, err := {{ packageName }}.Load{{ node.typeName.name }}(savedData, loadCtx)
	if err != nil {
		t.Fatalf("Failed to reload {{ node.typeName.name }}: %v", err)
	}
	
	{%- for validation in sample.validation %}
	if reloaded.{{ validation.key }} != {{ validation.delimeter }}{{ validation.value }}{{ validation.delimeter }} {
		t.Errorf("Expected {{ validation.key }} to be {{ validation.delimeter }}{{ validation.value }}{{ validation.delimeter }}, got %v", reloaded.{{ validation.key }})
	}
	{%- endfor %}
}

// Test{{ node.typeName.name }}ToJSON{% if not loop.first %}{{ loop.index - 1 }}{% endif %} tests that ToJSON produces valid JSON
func Test{{ node.typeName.name }}ToJSON{% if not loop.first %}{{ loop.index - 1 }}{% endif %}(t *testing.T) {
	jsonData := `
{%- for line in sample.json %}
{{ line }}
{%- endfor %}
`
	var data map[string]interface{}
	if err := json.Unmarshal([]byte(jsonData), &data); err != nil {
		t.Fatalf("Failed to parse JSON: %v", err)
	}
	
	ctx := {{ packageName }}.NewLoadContext()
	instance, err := {{ packageName }}.Load{{ node.typeName.name }}(data, ctx)
	if err != nil {
		t.Fatalf("Failed to load {{ node.typeName.name }}: %v", err)
	}
	
	jsonOutput, err := instance.ToJSON()
	if err != nil {
		t.Fatalf("Failed to convert to JSON: %v", err)
	}
	
	var parsed map[string]interface{}
	if err := json.Unmarshal([]byte(jsonOutput), &parsed); err != nil {
		t.Fatalf("Failed to parse generated JSON: %v", err)
	}
}

// Test{{ node.typeName.name }}ToYAML{% if not loop.first %}{{ loop.index - 1 }}{% endif %} tests that ToYAML produces valid YAML
func Test{{ node.typeName.name }}ToYAML{% if not loop.first %}{{ loop.index - 1 }}{% endif %}(t *testing.T) {
	jsonData := `
{%- for line in sample.json %}
{{ line }}
{%- endfor %}
`
	var data map[string]interface{}
	if err := json.Unmarshal([]byte(jsonData), &data); err != nil {
		t.Fatalf("Failed to parse JSON: %v", err)
	}
	
	ctx := {{ packageName }}.NewLoadContext()
	instance, err := {{ packageName }}.Load{{ node.typeName.name }}(data, ctx)
	if err != nil {
		t.Fatalf("Failed to load {{ node.typeName.name }}: %v", err)
	}
	
	yamlOutput, err := instance.ToYAML()
	if err != nil {
		t.Fatalf("Failed to convert to YAML: %v", err)
	}
	
	var parsed map[string]interface{}
	if err := yaml.Unmarshal([]byte(yamlOutput), &parsed); err != nil {
		t.Fatalf("Failed to parse generated YAML: %v", err)
	}
}

{% endfor %}
{% if alternates.length > 0 %}
{% for alt in alternates %}
// Test{{ node.typeName.name }}From{{ alt.title | capitalize }} tests loading {{ node.typeName.name }} from {{ alt.scalar }}
func Test{{ node.typeName.name }}From{{ alt.title | capitalize }}(t *testing.T) {
	ctx := {{ packageName }}.NewLoadContext()
	instance, err := {{ packageName }}.Load{{ node.typeName.name }}({{ alt.value }}, ctx)
	if err != nil {
		t.Fatalf("Failed to load {{ node.typeName.name }} from {{ alt.scalar }}: %v", err)
	}
	
	{%- for item in alt.validation %}
	if instance.{{ item.key }} != {{ item.delimeter }}{{ item.value }}{{ item.delimeter }} {
		t.Errorf("Expected {{ item.key }} to be {{ item.delimeter }}{{ item.value }}{{ item.delimeter }}, got %v", instance.{{ item.key }})
	}
	{%- endfor %}
}

{% endfor %}
{% endif %}
