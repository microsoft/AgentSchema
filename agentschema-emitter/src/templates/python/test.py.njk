{#
  Python Test Template
  ====================
  Renders pytest test file for a type.
  
  Expected context (BaseTestContext):
    - node: TypeNode
    - isAbstract: boolean
    - package: string
    - examples: Array<{ json: string[], yaml: string[], validations: Array<{ key, value, delimiter, isOptional }> }>
    - alternates: Array<{ title, scalarType, value, validations: Array<{ key, value, delimiter, isOptional }> }>
#}
{%- if examples.length > 0 %}
import json
import yaml
{% endif %}
from {{ node.typeName.namespace | lower }} import {{node.typeName.name}}

{% for sample in examples %}
def test_load_json_{{node.typeName.name | lower}}{% if not loop.first %}_{{loop.index - 1}}{% endif %}():
    json_data = '''
    {% for line in sample.json -%}
    {{ line }}
    {% endfor -%}
    '''
    data = json.loads(json_data, strict=False)
    instance = {{node.typeName.name}}.load(data)
    assert instance is not None
    {% for validation in sample.validations -%}
    {%- if validation.value == "True" or validation.value == "False" %}
    assert {% if validation.value == "False" %}not {% endif %}instance.{{ validation.key }}
    {% else -%}
    assert instance.{{ validation.key }} == {{ validation.delimiter }}{{ validation.value }}{{ validation.delimiter }}
    {% endif -%}
    {% endfor %}

def test_load_yaml_{{node.typeName.name | lower}}{% if not loop.first %}_{{loop.index - 1}}{% endif %}():
    yaml_data = '''
    {% for line in sample.yaml -%}
    {{ line }}
    {% endfor -%}
    '''
    data = yaml.load(yaml_data, Loader=yaml.FullLoader)
    instance = {{node.typeName.name}}.load(data)
    assert instance is not None
    {%- for validation in sample.validations %}
    {%- if validation.value == "True" or validation.value == "False" %}
    assert {% if validation.value == "False" %}not {% endif %}instance.{{ validation.key }}
    {%- else %}
    assert instance.{{ validation.key }} == {{ validation.delimiter }}{{ validation.value }}{{ validation.delimiter }}
    {%- endif %}
    {%- endfor %}

def test_roundtrip_json_{{node.typeName.name | lower}}{% if not loop.first %}_{{loop.index - 1}}{% endif %}():
    """Test that load -> save -> load produces equivalent data."""
    json_data = '''
    {% for line in sample.json -%}
    {{ line }}
    {% endfor -%}
    '''
    original_data = json.loads(json_data, strict=False)
    instance = {{node.typeName.name}}.load(original_data)
    saved_data = instance.save()
    reloaded = {{node.typeName.name}}.load(saved_data)
    assert reloaded is not None
    {%- for validation in sample.validations %}
    {%- if validation.value == "True" or validation.value == "False" %}
    assert {% if validation.value == "False" %}not {% endif %}reloaded.{{ validation.key }}
    {%- else %}
    assert reloaded.{{ validation.key }} == {{ validation.delimiter }}{{ validation.value }}{{ validation.delimiter }}
    {%- endif %}
    {%- endfor %}

def test_to_json_{{node.typeName.name | lower}}{% if not loop.first %}_{{loop.index - 1}}{% endif %}():
    """Test that to_json produces valid JSON."""
    json_data = '''
    {% for line in sample.json -%}
    {{ line }}
    {% endfor -%}
    '''
    data = json.loads(json_data, strict=False)
    instance = {{node.typeName.name}}.load(data)
    json_output = instance.to_json()
    assert json_output is not None
    parsed = json.loads(json_output)
    assert isinstance(parsed, dict)

def test_to_yaml_{{node.typeName.name | lower}}{% if not loop.first %}_{{loop.index - 1}}{% endif %}():
    """Test that to_yaml produces valid YAML."""
    json_data = '''
    {% for line in sample.json -%}
    {{ line }}
    {% endfor -%}
    '''
    data = json.loads(json_data, strict=False)
    instance = {{node.typeName.name}}.load(data)
    yaml_output = instance.to_yaml()
    assert yaml_output is not None
    parsed = yaml.safe_load(yaml_output)
    assert isinstance(parsed, dict)
{% endfor %}
{% if alternates.length > 0 %}
{% for alt in alternates -%}
def test_load_{{node.typeName.name | lower}}_from_{{ alt.scalarType }}():
    instance = {{node.typeName.name}}.load({{ alt.value }})
    assert instance is not None
    {%- for item in alt.validations %}
    {%- if item.value == "True" or item.value == "False" %}
    assert {% if item.value == "False" %}not {% endif %}instance.{{ item.key }}
    {%- else %}
    assert instance.{{ item.key }} == {{ item.delimiter }}{{ item.value }}{{ item.delimiter }}
    {%- endif %}
    {%- endfor %}
{% endfor %}
{% endif %}
