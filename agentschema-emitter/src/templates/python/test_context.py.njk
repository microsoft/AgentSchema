{# Template for generating LoadContext tests #}
{% from "macros.njk" import fileHeader %}
{{ fileHeader(header) }}
import pytest
from {{ package }}._context import LoadContext


class TestLoadContext:
    """Tests for LoadContext class."""

    def test_default_values(self) -> None:
        """Test that LoadContext has correct default values."""
        context = LoadContext()
        assert context.pre_process is None
        assert context.post_process is None

    def test_process_input_without_callback(self) -> None:
        """Test process_input returns original data when no callback set."""
        context = LoadContext()
        data = {"key": "value", "nested": {"a": 1}}
        result = context.process_input(data)
        assert result is data

    def test_process_input_with_callback(self) -> None:
        """Test process_input applies the pre_process callback."""
        def add_field(data: dict) -> dict:
            return {**data, "added": True}

        context = LoadContext(pre_process=add_field)
        data = {"key": "value"}
        result = context.process_input(data)
        assert result == {"key": "value", "added": True}
        assert result is not data

    def test_process_output_without_callback(self) -> None:
        """Test process_output returns original result when no callback set."""
        context = LoadContext()
        result = {"some": "result"}
        processed = context.process_output(result)
        assert processed is result

    def test_process_output_with_callback(self) -> None:
        """Test process_output applies the post_process callback."""
        def wrap_result(result: dict) -> dict:
            return {"wrapped": result}

        context = LoadContext(post_process=wrap_result)
        result = {"key": "value"}
        processed = context.process_output(result)
        assert processed == {"wrapped": {"key": "value"}}

    def test_both_callbacks(self) -> None:
        """Test using both pre_process and post_process callbacks."""
        def normalize_keys(data: dict) -> dict:
            return {k.lower(): v for k, v in data.items()}

        def add_metadata(result: dict) -> dict:
            return {**result, "_processed": True}

        context = LoadContext(pre_process=normalize_keys, post_process=add_metadata)
        
        input_data = {"Key": "value", "UPPER": "case"}
        processed_input = context.process_input(input_data)
        assert processed_input == {"key": "value", "upper": "case"}
        
        final_result = context.process_output(processed_input)
        assert final_result == {"key": "value", "upper": "case", "_processed": True}

    def test_pre_process_can_modify_structure(self) -> None:
        """Test that pre_process can fundamentally transform data structure."""
        def flatten_nested(data: dict) -> dict:
            result = {}
            for key, value in data.items():
                if isinstance(value, dict):
                    for nested_key, nested_value in value.items():
                        result[f"{key}_{nested_key}"] = nested_value
                else:
                    result[key] = value
            return result

        context = LoadContext(pre_process=flatten_nested)
        data = {"top": "level", "nested": {"a": 1, "b": 2}}
        result = context.process_input(data)
        assert result == {"top": "level", "nested_a": 1, "nested_b": 2}
